{% extends "django_models_from_csv/base.html" %}
{% load i18n static %}

{% block title %}
User Sign In Setup | {{ block.super }}
{% endblock %}

{% block extrahead %}
  {{ block.super }}
  {{ widget.media }}
  <style>
#csv-models-config .authentication .password input {
    min-width: 300px;
    margin-right: 20px;
}
#csv-models-config input[type="text"] {
    min-width: 600px;
}
  </style>
{% endblock %}

{% block content %}
<div id="csv-models-config">
  <h2>Google Credentials</h2>
  <form enctype="multipart/form-data"
        action="{% url 'setup-credentials' %}" method="POST">
    <h3>Google Sign In</h3>
    <p>
    {% blocktrans trimmed %}
    In order to allow users to sign in with their Google account, you need
    to request access from Google to do this. Specifically, you need
    something called OAuth2 keys from Google. To get these keys, follow
    these steps:
    {% endblocktrans %}
    </p>
    <ol>
      <li>
        <a href="https://console.developers.google.com/" target="_blank">
          {% trans "Go to the Google Developer's Console" %}.
        </a>
      </li>
      <li>
        {% blocktrans trimmed %}
        Create a new project
        {% endblocktrans %}
      </li>
      <li>
        {% blocktrans trimmed %}
        On the left, select "Credentials"
        {% endblocktrans %}
      </li>
      <li>
        {% blocktrans trimmed %}
        Select the "OAuth consent screen"
        {% endblocktrans %}
      </li>
      <li>
        {% blocktrans trimmed %}
        Give your application a name and support email. Click "Save" at the
        bottom
        {% endblocktrans %}
      </li>
      <li>
        {% blocktrans trimmed %}
        Go back to the "Credentials" tab. Click "Create credentials" &rarr;
        "OAuth client ID"
        {% endblocktrans %}
      </li>
      <li>
        {% blocktrans trimmed %}
        Select "Web application". This will expose more options.
        {% endblocktrans %}
      </li>
      <li>
        {% blocktrans trimmed %}
        Under "Authorized JavaScript origins" enter:
        {% endblocktrans %}
        <code>http://{{ hostname }}/</code><br/>
        {% blocktrans trimmed %}
        Under "Authorized redirect URIs" enter:
        {% endblocktrans %}
        <code>http://{{ hostname }}/complete/google-oauth2/</code><br/>
        {% blocktrans trimmed %}
        Click "Save".
        {% endblocktrans %}
      </li>
      <li>
        {% blocktrans trimmed %}
        This will bring up a prompt containing the Google
        OAuth2 Key and Secret. Copy each to the below input boxes.
        {% endblocktrans %}
      </li>
    </ol>
    <p>
    {% blocktrans trimmed %}
    Optionally, you can select one or more domains to whitelist. This will
    let users whose email addresses are within the whitelisted domain
    sign in, without needing to first create their user account.
    {% endblocktrans %}
    </p>
    <p>
    {% blocktrans trimmed %}
    If you didn't whitelist any domains, you'll need to pre-create each user
    that you want to be able sign in via Google Sign In. This can be done from
    the users section of the admin dashboard.
    {% endblocktrans %}
    </p>
    <table class="google-oauth">
      <tr>
        <td>
          {% trans 'Google OAuth2 Key' as google_oauth_key %}
          <label for="google_oauth_key">{{ google_oauth_key }}</label>
        </td>
        <td>
          <input name="google_oauth_key" type="text" placeholder="long code, e.g., 327832290-ajn..." />
        </td>
      </tr>
      <tr>
        <td>
          {% trans 'Google OAuth2 Secret' as google_oauth_secret %}
          <label for="google_oauth_secret">{{ google_oauth_secret }}</label>
        </td>
        <td>
          <input name="google_oauth_secret" type="text" placeholder="short code, e.g., a708absY_s..." />
        </td>
      </tr>
      <tr>
        <td>
          {% trans 'Whitelist Domains (Optional)' as google_whitelist_domains %}
          <label for="google_whitelist_domains">{{ google_whitelist_domains }}</label>
        </td>
        <td>
          <input name="google_whitelist_domains"
                 type="text"
                 placeholder="Comma-separated list of domains, e.g. propublica.org,some.tld" />
        </td>
      </tr>
    </table>

    <h3>Google Redaction (Data Loss Prevention)</h3>
    <p>
    {% blocktrans trimmed %}
    To have the app automatically redact personally identifiable
    information (names, phone numbers, email addresses, etc) upon import
    from a spreadsheet, you can use the Google Data Loss Prevention (DLP)
    service. This requires you to create a DLP credentials file and setting
    up a billing account with Google, by following the instructions below.
    {% endblocktrans %}
    </p>
    <p>
    {% blocktrans trimmed %}
    Note: This will not remove the information from the source data.
    This will only prevent it from being saved to the collaborative app's
    database.
    {% endblocktrans %}
    </p>
    <h4>Instructions</h4>

<ol>
<li>Go to the <a href="https://console.developers.google.com">Google Developer's Console</a></li>
<li>Create a new project, or select an existing one (if you've already set up Google private sheets, for example).</li>
<li><p>From the drop down navigation menu on the top left, select "IAM &amp;
admin" &rarr; "Service accounts".</p>

<p><img src="{% static '/collaborative/dlp/01-navigate-to-service-accounts.png' %}" alt="Select service accounts" title="" /></p></li>
<li><p>Click "Create Service Account" at the top of the service accounts page.</p>

<p><img src="{% static '/collaborative/dlp/02-create-new-service-account.png' %}" alt="Select create new service account" title="" /></p></li>
<li><p>Name your new Google Redactor service account.</p>

<p><img src="{% static '/collaborative/dlp/03-create-service-account.png' %}" alt="Name your service account" title="" /></p></li>
<li><p>Open the "Select a role" menu, search for "DLP User" and select that role to
grant your account access to the redactor service.</p>

<p><img src="{% static '/collaborative/dlp/04a-open-select-a-role-menu.png' %}" alt="Open select a role menu" title="" /></p>

<p><img src="{% static '/collaborative/dlp/04b-grant-dlp-user-role.png' %}" alt="Grant DLP User role" title="" /></p></li>
<li><p>Select "Create Key" and, in the right tab that opens, select a JSON key and
click "Create". Save the credentials file it gives you. Finally, click the
"Done" button below the newly created keys list.</p>

<p><img src="{% static '/collaborative/dlp/05a-click-create-key.png' %}" alt="Click create key" title="" /></p>

<p><img src="{% static '/collaborative/dlp/05b-save-json-credentials.png' %}" alt="Save JSON credentials" title="" /></p>

<p><img src="{% static '/collaborative/dlp/06-select-done.png' %}" alt="Click done" title="" /></p></li>
<li><p>Go to the <a href="https://console.cloud.google.com/apis/library/dlp.googleapis.com">Google Cloud API screen for Google DLP</a>.
Click "Enable". Cloud DLP requires you set up a billing account with Google.
If you haven't done this, you will be asked to go through the account
wizard. At the end, you will be directed back to this screen, where you
can click "Enable" again. Note that Google has a
<a href="https://cloud.google.com/dlp/pricing">free tier</a> and that you
can use your free credits towards the service.</p>

<p><img src="{% static '/collaborative/dlp/07-enable-cloud-dlp.png' %}" alt="Enable cloud DLP" title="" /></p>

<p><img src="{% static '/collaborative/dlp/08-enable-billing.png' %}" alt="Enable billing, if you haven't" title="" /></p></li>
<li><p>Upload the credentials file to the collaborative system. You are now
ready to select fields for redaction, by clicking the checkbox on the import
and refine screen.</p>

<p><img src="{% static '/collaborative/dlp/09-upload-credentials.png' %}" alt="Upload credentials file" title="" /></p></li>
</ol>


    <table class="google-redaction">
      <tr>
        <td>
            <label for="google_redaction_credentials">
                {% trans 'Credentials File' %}
            </label>
        </td>
        <td>
          <input name="google_redaction_credentials"
                 accept=".json"
                 type="file" />
        </td>
      </tr>
    </table>

    {% csrf_token %}
    <div class="continue">
      <input type="submit" value="{% trans 'Continue' %}" />
    </div>
  </form>
</div>
{% endblock %}
